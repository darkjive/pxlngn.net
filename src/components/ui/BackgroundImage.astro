---
/**
 * BackgroundImage Component
 *
 * Responsive Hintergrund-Bilder mit Dark Mode und Device-spezifischen Varianten.
 *
 * Features:
 * - Type-Safety für alle Image-Attribute
 * - Automatische Responsive-Varianten (_m für Mobile, _d für Desktop)
 * - Dark-Mode Unterstützung (_dark Suffix)
 * - Performance-Hints (loading, fetchpriority)
 * - Fallback auf Original-Bild wenn Varianten nicht existieren
 *
 * Dateinamens-Konvention:
 * - Basis: /images/background.webp
 * - Light Mobile: /images/background_m.webp
 * - Light Desktop: /images/background_d.webp
 * - Dark Mobile: /images/background_dark_m.webp
 * - Dark Desktop: /images/background_dark_d.webp
 *
 * @example
 * <BackgroundImage
 *   src="/images/background.webp"
 *   fetchpriority="high"
 *   loading="eager"
 * />
 */

interface Props {
  /** Bild-Quelle (public/ oder /images/ Pfad) */
  src: string;
  /** Alt-Text für Accessibility (default: leer für dekorative Bilder) */
  alt?: string;
  /** Bild-Breite in Pixeln (default: 1920) */
  width?: number;
  /** Bild-Höhe in Pixeln (default: 1080) */
  height?: number;
  /** Loading-Strategie (default: lazy) */
  loading?: 'lazy' | 'eager';
  /** Fetch-Priority für LCP-Optimierung (default: auto) */
  fetchpriority?: 'high' | 'low' | 'auto';
  /** Zusätzliche CSS-Klassen */
  class?: string;
  /** Zeige Border (default: true) */
  showBorder?: boolean;
}

const {
  src,
  alt = '',
  width = 1920,
  height = 1080,
  loading = 'lazy',
  fetchpriority = 'auto',
  class: className = '',
  showBorder = true,
} = Astro.props;

/**
 * Generiert Bildvarianten für responsive und Dark Mode Support
 * @param baseSrc - Basis-Bildpfad (z.B. /images/background.webp)
 * @returns Objekt mit allen Bildvarianten
 */
function generateImageVariants(baseSrc: string) {
  // Parse Pfad: /images/background.webp → { path: /images/, name: background, ext: .webp }
  const lastSlashIndex = baseSrc.lastIndexOf('/');
  const lastDotIndex = baseSrc.lastIndexOf('.');

  const path = baseSrc.substring(0, lastSlashIndex + 1);
  const name = baseSrc.substring(lastSlashIndex + 1, lastDotIndex);
  const ext = baseSrc.substring(lastDotIndex);

  return {
    // Light Mode Varianten
    lightMobile: `${path}${name}_m${ext}`,
    lightDesktop: `${path}${name}_d${ext}`,

    // Dark Mode Varianten
    darkMobile: `${path}${name}_dark_m${ext}`,
    darkDesktop: `${path}${name}_dark_d${ext}`,

    // Fallback
    fallback: baseSrc,
  };
}

const variants = generateImageVariants(src);
---

<!--
  Picture-Element mit mehreren Source-Varianten
  Browser wählt automatisch basierend auf:
  - prefers-color-scheme (dark/light)
  - min-width Media Query (mobile/desktop)
-->
<picture class:list={['absolute inset-0 h-full w-full', { 'section-border': showBorder }, className]}>
  <!-- Dark Mode Desktop (min-width: 768px) -->
  <source
    srcset={variants.darkDesktop}
    media="(prefers-color-scheme: dark) and (min-width: 768px)"
    width={width}
    height={height}
  />

  <!-- Dark Mode Mobile (max-width: 767px) -->
  <source
    srcset={variants.darkMobile}
    media="(prefers-color-scheme: dark) and (max-width: 767px)"
    width={width}
    height={height}
  />

  <!-- Light Mode Desktop (min-width: 768px) -->
  <source
    srcset={variants.lightDesktop}
    media="(prefers-color-scheme: light) and (min-width: 768px)"
    width={width}
    height={height}
  />

  <!-- Light Mode Mobile (max-width: 767px) -->
  <source
    srcset={variants.lightMobile}
    media="(prefers-color-scheme: light) and (max-width: 767px)"
    width={width}
    height={height}
  />

  <!-- Fallback: Original-Bild wenn keine Variante passt -->
  <img
    src={variants.fallback}
    alt={alt}
    width={width}
    height={height}
    loading={loading}
    fetchpriority={fetchpriority}
    class="h-full w-full object-cover"
  />
</picture>
