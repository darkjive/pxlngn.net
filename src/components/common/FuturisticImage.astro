---
/**
 * Futuristic Image Component with Progressive Loading
 * Features:
 * - Cyber-style skeleton loader with scanlines
 * - Progressive blur-up loading
 * - Neon glow effects
 * - Smooth transitions
 * - Performance optimized with Intersection Observer
 */
import type { HTMLAttributes } from 'astro/types';
import { findImage } from '~/utils/images';
import {
  getImagesOptimized,
  astroAsseetsOptimizer,
  unpicOptimizer,
  isUnpicCompatible,
  type ImageProps,
} from '~/utils/images-optimization';
import FuturisticLoader from '~/components/ui/FuturisticLoader.astro';

type Props = ImageProps & {
  futuristicEffect?: 'cyber' | 'neon' | 'minimal';
  glowColor?: string;
};

type ImageType = {
  src: string;
  attributes: HTMLAttributes<'img'>;
};

const props = Astro.props;
const { futuristicEffect = 'cyber', glowColor = 'cyan' } = props;

if (props.alt === undefined || props.alt === null) {
  throw new Error('Alt text is required for FuturisticImage');
}

if (typeof props.width === 'string') {
  props.width = parseInt(props.width);
}

if (typeof props.height === 'string') {
  props.height = parseInt(props.height);
}

if (!props.loading) {
  props.loading = 'lazy';
}

if (!props.decoding) {
  props.decoding = 'async';
}

const _image = await findImage(props.src);

let image: ImageType | undefined = undefined;
let blurDataUrl: string | undefined = undefined;

if (
  typeof _image === 'string' &&
  (_image.startsWith('http://') || _image.startsWith('https://')) &&
  isUnpicCompatible(_image)
) {
  image = await getImagesOptimized(_image, props, unpicOptimizer);
} else if (_image) {
  // Use AVIF format by default for better compression
  if (!props.format) {
    props.format = 'avif';
  }
  image = await getImagesOptimized(_image, props, astroAsseetsOptimizer);

  // Generate tiny blur placeholder (20px width)
  const blurImage = await getImagesOptimized(
    _image,
    { ...props, width: 20, height: 20, format: 'webp' },
    astroAsseetsOptimizer
  );
  blurDataUrl = blurImage.src;
}

const uniqueId = `futuristic-img-${Math.random().toString(36).substr(2, 9)}`;
---

{
  !image ? (
    <Fragment />
  ) : (
    <div class={`futuristic-image-wrapper ${futuristicEffect}`} data-futuristic-wrapper id={uniqueId}>
      {/* Cyber Skeleton Loader Component */}
      <FuturisticLoader glowColor={glowColor} effect={futuristicEffect} />

      {/* Blur Placeholder */}
      {blurDataUrl && (
        <img src={blurDataUrl} alt="" aria-hidden="true" class="blur-placeholder" data-blur-placeholder />
      )}

      {/* Actual Image */}
      <img
        src={image.src}
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
        class="futuristic-image"
        data-futuristic-image
        data-glitch={props['data-glitch']}
        {...image.attributes}
      />
    </div>
  )
}

<style is:global>
  /* Futuristic Image Wrapper - Main Container */
  .futuristic-image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, rgba(13, 173, 221, 0.9) 0%, rgba(247, 182, 3, 0.9) 100%);
    contain: layout style paint;
  }

  /* Blur Placeholder - Progressive Loading */
  .blur-placeholder {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: blur(20px);
    transform: scale(1.1);
    z-index: 1;
    opacity: 1;
    transition: opacity 0.6s ease-out;
    will-change: opacity;
  }

  .blur-placeholder.loaded {
    opacity: 0;
  }

  /* Actual Image - Main Content */
  .futuristic-image {
    position: relative;
    z-index: 2;
    opacity: 0;
    transform: scale(0.95) translateZ(0);
    transition:
      opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
      0 0 40px rgba(0, 195, 255, 0.2),
      inset 0 0 20px rgba(0, 195, 255, 0.1);
    will-change: opacity, transform;
  }

  .futuristic-image.loaded {
    opacity: 1;
    transform: scale(1) translateZ(0);
  }
</style>

<script>
  /**
   * Import and initialize Futuristic Image Progressive Loading
   * Uses optimized TypeScript module with Intersection Observer
   */
  import '~/utils/futuristic-image-loader';
</script>
