---
import merge from 'lodash.merge';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || 'de',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    openGraph: METADATA?.openGraph,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    openGraph: { url: canonical, ...openGraph },
    twitter: twitter,
  }
);

const finalTitle = seoProps.titleTemplate && seoProps.title
  ? seoProps.titleTemplate.replace('%s', seoProps.title)
  : seoProps.title;

const adaptedOpenGraph = await adaptOpenGraphImages(seoProps?.openGraph, Astro.site);
---

<!-- Title -->
{finalTitle && <title>{finalTitle}</title>}

<!-- Canonical -->
{seoProps.canonical && <link rel="canonical" href={seoProps.canonical} />}

<!-- Robots -->
{(seoProps.noindex || seoProps.nofollow) && (
  <meta
    name="robots"
    content={`${seoProps.noindex ? 'noindex' : 'index'},${seoProps.nofollow ? 'nofollow' : 'follow'}`}
  />
)}

<!-- Description -->
{seoProps.description && <meta name="description" content={seoProps.description} />}

<!-- Open Graph -->
{adaptedOpenGraph?.url && <meta property="og:url" content={adaptedOpenGraph.url} />}
{adaptedOpenGraph?.type && <meta property="og:type" content={adaptedOpenGraph.type} />}
{finalTitle && <meta property="og:title" content={finalTitle} />}
{seoProps.description && <meta property="og:description" content={seoProps.description} />}
{adaptedOpenGraph?.site_name && <meta property="og:site_name" content={adaptedOpenGraph.site_name} />}
{adaptedOpenGraph?.locale && <meta property="og:locale" content={adaptedOpenGraph.locale} />}
{adaptedOpenGraph?.images?.map((image: { url: string; width?: number; height?: number }) => (
  <>
    <meta property="og:image" content={image.url} />
    {image.width && <meta property="og:image:width" content={String(image.width)} />}
    {image.height && <meta property="og:image:height" content={String(image.height)} />}
  </>
))}

<!-- Twitter -->
{seoProps.twitter?.cardType && <meta name="twitter:card" content={seoProps.twitter.cardType} />}
{seoProps.twitter?.site && <meta name="twitter:site" content={seoProps.twitter.site} />}
{seoProps.twitter?.handle && <meta name="twitter:creator" content={seoProps.twitter.handle} />}
{finalTitle && <meta name="twitter:title" content={finalTitle} />}
{seoProps.description && <meta name="twitter:description" content={seoProps.description} />}
{adaptedOpenGraph?.images?.[0]?.url && <meta name="twitter:image" content={adaptedOpenGraph.images[0].url} />}
